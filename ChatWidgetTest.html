<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AJK Cleaning - Enhanced Chat Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 800px;
            overflow: hidden;
        }

        header {
            background: #4a5568;
            color: white;
            padding: 20px;
            text-align: center;
        }

        h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .chat-container {
            display: flex;
            height: 500px;
        }

        .client-list {
            width: 200px;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            background: #f7fafc;
        }

        .client-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .client-item:hover {
            background: #edf2f7;
        }

        .client-item.active {
            background: #4299e1;
            color: white;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 5px;
            position: relative;
        }

        .message.admin {
            align-self: flex-end;
            background: #4299e1;
            color: white;
        }

        .message.client {
            align-self: flex-start;
            background: #edf2f7;
            color: #4a5568;
        }

        .message.system {
            align-self: center;
            background: #faf089;
            color: #744210;
            font-style: italic;
        }

        .message-info {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.8;
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .chat-input button {
            padding: 12px 20px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-input button:hover {
            background: #38a169;
        }

        .chat-input button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .connection-status {
            padding: 10px 15px;
            background: #edf2f7;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-connected {
            background: #48bb78;
        }

        .status-disconnected {
            background: #e53e3e;
        }

        .status-connecting {
            background: #f6ad55;
        }

        .no-messages {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        .device-id {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }

        .typing-indicator {
            padding: 5px 15px;
            font-style: italic;
            color: #718096;
            height: 20px;
        }

        .connection-controls {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: #edf2f7;
            border-bottom: 1px solid #e2e8f0;
        }

        .connection-controls button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .connect-btn {
            background: #48bb78;
            color: white;
        }

        .disconnect-btn {
            background: #e53e3e;
            color: white;
        }

        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
                height: 600px;
            }
            
            .client-list {
                width: 100%;
                height: 120px;
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AJK Cleaning Chat System</h1>
        </header>
        
        <div class="connection-controls">
            <button id="connect-btn" class="connect-btn">Connect to Server</button>
            <button id="disconnect-btn" class="disconnect-btn" disabled>Disconnect</button>
        </div>
        
        <div class="chat-container">
            <div class="client-list" id="client-list">
                <div class="client-item active" data-client-id="current">
                    <div>Your Device</div>
                    <div class="device-id" id="current-device-id">ID: Loading...</div>
                </div>
            </div>
            
            <div class="chat-area">
                <div class="chat-messages" id="chat-messages">
                    <div class="no-messages">Not connected to server. Click "Connect to Server" to start.</div>
                </div>
                
                <div class="typing-indicator" id="typing-indicator"></div>
                
                <div class="chat-input">
                    <input type="text" id="message-input" placeholder="Type a message..." disabled>
                    <button id="send-button" disabled>Send</button>
                </div>
            </div>
        </div>
        
        <div class="connection-status">
            <div>
                <span class="status-indicator status-disconnected" id="status-indicator"></span>
                <span id="status-text">Disconnected</span>
            </div>
            <div>
                <button id="clear-chat">Clear Chat</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const chatMessages = document.getElementById('chat-messages');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const statusText = document.getElementById('status-text');
            const statusIndicator = document.getElementById('status-indicator');
            const clearChatButton = document.getElementById('clear-chat');
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');
            const typingIndicator = document.getElementById('typing-indicator');
            const clientList = document.getElementById('client-list');
            
            // WebSocket and state variables
            let ws = null;
            let clientId = null;
            let isAdmin = false;
            let reconnectAttempts = 0;
            let typingTimer = null;
            
            // Generate a unique device ID for this browser session
            function generateDeviceId() {
                // Use existing ID if available
                if (localStorage.getItem('deviceId')) {
                    return localStorage.getItem('deviceId');
                }
                
                // Generate new ID
                const id = 'client_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', id);
                return id;
            }
            
            // Update connection status UI
            function updateConnectionStatus(status, message) {
                statusIndicator.className = 'status-indicator status-' + status;
                statusText.textContent = message;
                
                // Enable/disable UI elements based on connection status
                const isConnected = status === 'connected';
                messageInput.disabled = !isConnected;
                sendButton.disabled = !isConnected;
                disconnectBtn.disabled = !isConnected;
                connectBtn.disabled = isConnected;
            }
            
            // Connect to WebSocket server
            function connectToServer() {
                updateConnectionStatus('connecting', 'Connecting...');
                
                // Determine WebSocket protocol (ws or wss)
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}`;
                
                try {
                    ws = new WebSocket(wsUrl);
                    
                    ws.onopen = function() {
                        console.log('WebSocket connection established');
                        reconnectAttempts = 0;
                        updateConnectionStatus('connected', 'Connected to server');
                        
                        // Identify client to server
                        const deviceId = generateDeviceId();
                        clientId = deviceId;
                        document.getElementById('current-device-id').textContent = `ID: ${deviceId}`;
                        
                        // Send identification message
                        ws.send(JSON.stringify({
                            type: 'identify',
                            name: 'User ' + deviceId.substr(7, 4),
                            clientId: deviceId,
                            isAdmin: false
                        }));
                    };
                    
                    ws.onmessage = function(event) {
                        try {
                            const message = JSON.parse(event.data);
                            handleServerMessage(message);
                        } catch (error) {
                            console.error('Error parsing message from server:', error);
                        }
                    };
                    
                    ws.onclose = function(event) {
                        console.log('WebSocket connection closed:', event.code, event.reason);
                        updateConnectionStatus('disconnected', 'Disconnected from server');
                        
                        // Attempt to reconnect with exponential backoff
                        if (reconnectAttempts < 5) {
                            const delay = Math.pow(2, reconnectAttempts) * 1000;
                            setTimeout(connectToServer, delay);
                            reconnectAttempts++;
                        }
                    };
                    
                    ws.onerror = function(error) {
                        console.error('WebSocket error:', error);
                        updateConnectionStatus('disconnected', 'Connection error');
                    };
                    
                } catch (error) {
                    console.error('Failed to create WebSocket connection:', error);
                    updateConnectionStatus('disconnected', 'Connection failed');
                }
            }
            
            // Handle messages from server
            function handleServerMessage(message) {
                console.log('Received message from server:', message);
                
                switch (message.type) {
                    case 'client_id':
                        clientId = message.clientId;
                        document.getElementById('current-device-id').textContent = `ID: ${clientId}`;
                        break;
                        
                    case 'chat':
                        displayMessage({
                            id: message.id,
                            text: message.message,
                            sender: message.isAdmin ? 'admin' : 'client',
                            name: message.name,
                            timestamp: new Date(message.timestamp),
                            clientId: message.clientId
                        });
                        break;
                        
                    case 'system':
                        displayMessage({
                            id: 'system-' + Date.now(),
                            text: message.message,
                            sender: 'system',
                            timestamp: new Date(message.timestamp)
                        });
                        break;
                        
                    case 'typing':
                        if (message.isTyping && message.clientId !== clientId) {
                            showTypingIndicator(message.name);
                        } else {
                            hideTypingIndicator();
                        }
                        break;
                        
                    case 'history':
                        // Clear existing messages
                        chatMessages.innerHTML = '';
                        
                        // Display message history
                        if (message.messages && message.messages.length > 0) {
                            message.messages.forEach(msg => {
                                displayMessage({
                                    id: msg.id,
                                    text: msg.message,
                                    sender: msg.isAdmin ? 'admin' : 'client',
                                    name: msg.name,
                                    timestamp: new Date(msg.timestamp),
                                    clientId: msg.clientId
                                }, false);
                            });
                        } else {
                            chatMessages.innerHTML = '<div class="no-messages">No messages yet. Start a conversation!</div>';
                        }
                        break;
                        
                    case 'admin':
                        // Admin notification (could be shown in a special way)
                        console.log('Admin notification:', message.message);
                        break;
                }
            }
            
            // Display message in chat
            function displayMessage(message, scroll = true) {
                // Remove no messages placeholder if it exists
                const noMessages = document.querySelector('.no-messages');
                if (noMessages) noMessages.remove();
                
                const messageEl = document.createElement('div');
                messageEl.className = `message ${message.sender}`;
                messageEl.dataset.id = message.id;
                
                const time = message.timestamp.toLocaleTimeString();
                const name = message.sender === 'admin' ? 'Support' : (message.name || 'User');
                
                messageEl.innerHTML = `
                    <div class="message-text">${message.text}</div>
                    <div class="message-info">
                        ${name} • ${time}
                    </div>
                `;
                
                // Check for duplicates before adding
                if (!document.querySelector(`.message[data-id="${message.id}"]`)) {
                    chatMessages.appendChild(messageEl);
                    if (scroll) {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                }
            }
            
            // Send message to server
            function sendMessageToServer() {
                const messageText = messageInput.value.trim();
                if (!messageText || !ws || ws.readyState !== WebSocket.OPEN) return;
                
                // Send chat message
                ws.send(JSON.stringify({
                    type: 'chat',
                    message: messageText,
                    clientId: clientId
                }));
                
                // Clear input
                messageInput.value = '';
                messageInput.focus();
            }
            
            // Show typing indicator
            function showTypingIndicator(name) {
                typingIndicator.textContent = `${name} is typing...`;
                
                // Clear previous timer if exists
                if (typingTimer) {
                    clearTimeout(typingTimer);
                }
                
                // Hide typing indicator after 3 seconds
                typingTimer = setTimeout(() => {
                    hideTypingIndicator();
                }, 3000);
            }
            
            // Hide typing indicator
            function hideTypingIndicator() {
                typingIndicator.textContent = '';
            }
            
            // Handle typing events
            function handleTypingEvent() {
                if (!ws || ws.readyState !== WebSocket.OPEN) return;
                
                // Send typing start indicator
                ws.send(JSON.stringify({
                    type: 'typing',
                    isTyping: true,
                    clientId: clientId
                }));
                
                // Set timeout to send typing stop indicator
                setTimeout(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'typing',
                            isTyping: false,
                            clientId: clientId
                        }));
                    }
                }, 1000);
            }
            
            // Disconnect from server
            function disconnectFromServer() {
                if (ws) {
                    ws.close();
                    ws = null;
                }
                updateConnectionStatus('disconnected', 'Disconnected');
                chatMessages.innerHTML = '<div class="no-messages">Disconnected from server</div>';
            }
            
            // Event listeners
            connectBtn.addEventListener('click', connectToServer);
            disconnectBtn.addEventListener('click', disconnectFromServer);
            
            sendButton.addEventListener('click', sendMessageToServer);
            
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessageToServer();
                }
            });
            
            messageInput.addEventListener('input', handleTypingEvent);
            
            clearChatButton.addEventListener('click', function() {
                chatMessages.innerHTML = '';
                const noMessages = document.createElement('div');
                noMessages.className = 'no-messages';
                noMessages.textContent = 'No messages yet. Start a conversation!';
                chatMessages.appendChild(noMessages);
            });
            
            // Initialize device ID
            const deviceId = generateDeviceId();
            document.getElementById('current-device-id').textContent = `ID: ${deviceId}`;
        });
    </script>
</body>
</html>